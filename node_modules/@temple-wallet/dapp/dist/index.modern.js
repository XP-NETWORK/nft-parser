import{nanoid as e}from"nanoid";import{TezosOperationError as t,TezosToolkit as s,createTransferOperation as n,createOriginationOperation as r,createSetDelegateOperation as a}from"@taquito/taquito";var i,o,c;function u(){return new Promise(e=>{const t=e=>{var t,n;e.source===window&&(null===(t=e.data)||void 0===t?void 0:t.type)===c.Response&&"PONG"===(null===(n=e.data)||void 0===n?void 0:n.payload)&&s(!0)},s=s=>{e(s),window.removeEventListener("message",t),clearTimeout(n)};g({type:c.Request,payload:"PING"}),window.addEventListener("message",t);const n=setTimeout(()=>s(!1),500)})}function m(e){let t,s=!1;const n=async(r=0)=>{const a=r<5,i=await u();s!==i&&(e(i),s=i),t=setTimeout(n,i?1e4:a?0:5e3,a?r+1:r)};return n(),()=>clearTimeout(t)}function p(e){let t,s=null;const n=async()=>{try{const t=await l();a=s,(null===(r=t)?null===a:r.pkh===(null==a?void 0:a.pkh)&&r.rpc===(null==a?void 0:a.rpc))||(e(t),s=t)}catch(e){}var r,a;t=setTimeout(n,1e4)};return n(),()=>clearTimeout(t)}async function l(){const e=await R({type:i.GetCurrentPermissionRequest});return f(e.type===i.GetCurrentPermissionResponse),e.permission}async function d(e,t,s){const n=await R({type:i.PermissionRequest,network:e,appMeta:t,force:s});return f(n.type===i.PermissionResponse),{rpc:n.rpc,pkh:n.pkh,publicKey:n.publicKey}}async function P(e,t){const s=await R({type:i.OperationRequest,sourcePkh:e,opParams:t});return f(s.type===i.OperationResponse),s.opHash}async function E(e,t){const s=await R({type:i.SignRequest,sourcePkh:e,payload:t});return f(s.type===i.SignResponse),s.signature}async function h(e){const t=await R({type:i.BroadcastRequest,signedOpBytes:e});return f(t.type===i.BroadcastResponse),t.opHash}function R(s){return new Promise((n,r)=>{const a=e(),i=e=>{const s=e.data;switch(!0){case e.source!==window||(null==s?void 0:s.reqId)!==a:return;case(null==s?void 0:s.type)===c.Response:n(s.payload),window.removeEventListener("message",i);break;case(null==s?void 0:s.type)===c.ErrorResponse:r(function(e){switch(!0){case e===o.NotGranted:return new w;case e===o.NotFound:return new S;case e===o.InvalidParams:return new T;case Array.isArray(e)&&e[0]===o.TezosOperation&&Array.isArray(e[1])&&e[1].length>0:return new t(e[1]);case"string"==typeof e&&e.startsWith("__tezos__"):return new Error(e.replace("__tezos__",""));default:return new y}}(s.payload)),window.removeEventListener("message",i)}};g({type:c.Request,payload:s,reqId:a}),window.addEventListener("message",i)})}function f(e){if(!e)throw new Error("Invalid response recieved")}function g(e){window.postMessage(e,"*")}!function(e){e.GetCurrentPermissionRequest="GET_CURRENT_PERMISSION_REQUEST",e.GetCurrentPermissionResponse="GET_CURRENT_PERMISSION_RESPONSE",e.PermissionRequest="PERMISSION_REQUEST",e.PermissionResponse="PERMISSION_RESPONSE",e.OperationRequest="OPERATION_REQUEST",e.OperationResponse="OPERATION_RESPONSE",e.SignRequest="SIGN_REQUEST",e.SignResponse="SIGN_RESPONSE",e.BroadcastRequest="BROADCAST_REQUEST",e.BroadcastResponse="BROADCAST_RESPONSE"}(i||(i={})),function(e){e.NotGranted="NOT_GRANTED",e.NotFound="NOT_FOUND",e.InvalidParams="INVALID_PARAMS",e.TezosOperation="TEZOS_OPERATION"}(o||(o={})),function(e){e.Request="TEMPLE_PAGE_REQUEST",e.Response="TEMPLE_PAGE_RESPONSE",e.ErrorResponse="TEMPLE_PAGE_ERROR_RESPONSE"}(c||(c={}));class y{constructor(){this.name="TempleWalletError",this.message="An unknown error occured. Please try again or report it"}}class w extends y{constructor(...e){super(...e),this.name="NotGrantedTempleWalletError",this.message="Permission Not Granted"}}class S extends y{constructor(...e){super(...e),this.name="NotFoundTempleWalletError",this.message="Account Not Found. Try connect again"}}class T extends y{constructor(...e){super(...e),this.name="InvalidParamsTempleWalletError",this.message="Some of the parameters you provided are invalid"}}function v(){return v=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&(e[n]=s[n])}return e},v.apply(this,arguments)}function O(e,t){if(null==e)return{};var s,n,r={},a=Object.keys(e);for(n=0;n<a.length;n++)t.indexOf(s=a[n])>=0||(r[s]=e[s]);return r}const _=["fee","gas_limit","storage_limit"],N=["destination","amount","parameters"];class L{constructor(e,t){this.appName=void 0,this.permission=null,this.appName=e,t&&(this.permission=t)}get connected(){return Boolean(this.permission)}toTezos(){I(this.permission);const e=new s(this.permission.rpc);return e.setProvider({wallet:this}),e}async connect(e,t={forcePermission:!1}){const s=await d(e,{name:this.appName},t.forcePermission);this.permission=s}reconnect(e){return this.connect(e,{forcePermission:!0})}async getPKH(){return I(this.permission),this.permission.pkh}async mapTransferParamsToWalletParams(e){const t=await e();return this.removeDefaultParams(t,await n(this.formatParameters(t)))}async mapOriginateParamsToWalletParams(e){const t=await e();return this.removeDefaultParams(t,await r(this.formatParameters(t)))}async mapDelegateParamsToWalletParams(e){const t=await e();return this.removeDefaultParams(t,await a(this.formatParameters(t)))}async sendOperations(e){return I(this.permission),P(this.permission.pkh,e.map(G))}async sign(e){return I(this.permission),E(this.permission.pkh,e)}async broadcast(e){return I(this.permission),h(e)}formatParameters(e){return e.fee&&(e.fee=e.fee.toString()),e.storageLimit&&(e.storageLimit=e.storageLimit.toString()),e.gasLimit&&(e.gasLimit=e.gasLimit.toString()),e}removeDefaultParams(e,t){return e.fee||delete t.fee,e.storageLimit||delete t.storage_limit,e.gasLimit||delete t.gas_limit,t}}L.isAvailable=u,L.onAvailabilityChange=m,L.getCurrentPermission=l,L.onPermissionChange=p;class A extends y{constructor(...e){super(...e),this.name="TempleWalletNotConnected",this.message="You need to connect TempleWallet by calling templeWallet.connect() first"}}function I(e){if(!e)throw new A}function G(e){const{fee:t,gas_limit:s,storage_limit:n}=e,r=O(e,_);switch(e.kind){case"origination":return v({},r,{mutez:!0,fee:t,gasLimit:s,storageLimit:n});case"transaction":const{destination:e,amount:a,parameters:i}=r;return v({},O(r,N),{to:e,amount:+a,mutez:!0,parameter:i,fee:t,gasLimit:s,storageLimit:n});default:return v({},r,{fee:t,gasLimit:s,storageLimit:n})}}export{T as InvalidParamsTempleWalletError,A as NotConnectedTempleWalletError,S as NotFoundTempleWalletError,w as NotGrantedTempleWalletError,o as TempleDAppErrorType,i as TempleDAppMessageType,c as TemplePageMessageType,L as TempleWallet,y as TempleWalletError,l as getCurrentPermission,u as isAvailable,m as onAvailabilityChange,p as onPermissionChange,h as requestBroadcast,P as requestOperation,d as requestPermission,E as requestSign};
//# sourceMappingURL=index.modern.js.map
